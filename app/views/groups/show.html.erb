<%= @group.name %>

<h2>メンバーを追加</h2>
<%= form_with model: @user, url: group_users_path(@group.id), local: true do |f| %>
  <div class="form-group">
    <%= f.label :name, "ユーザー名", class: "form-label" %>
    <%= f.text_field :name, class: "form-control", required: true %>
  </div>

  <%= f.submit "追加する", class: "btn btn-primary btn-block" %>
<% end %>

<h2>メンバー一覧</h2>
<% @group.users.each do |user| %>
  <%= user.name %>
<% end %>

<h2>支払い</h2>
  <% if @expense.errors.any? %>
    <div class="alert alert-danger">
      <h4><%= pluralize(@expense.errors.count, "エラー") %>があります:</h4>
      <ul>
        <% @expense.errors.each do |attribute, message| %>
          <li><%= @expense.class.human_attribute_name(attribute) + message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

<%= form_with model: @expense, url: group_expenses_path(@group.id), local: true do |f| %>

  <h3>誰が？</h3>
  <div class="form-group">
    <%= f.label :payer_id, "支払った人" %>
    <%= f.select :payer_id, options_from_collection_for_select(@members, :id, :name), {}, class: "form-control" %>
  </div>

  <h3>誰に？</h3>
  <div class="form-group">
    <%= f.label :members, "割り勘するメンバー" %><br>
    <%= f.collection_check_boxes(:user_ids, @members, :id, :name) do |b| %>
      <%= b.check_box(class: "form-check-input", checked: true) %>
      <%= b.label(class: "form-check-label") %>
    <% end %>
  </div>

  <h3>何を？</h3>
  <div class="form-group">
    <%= f.label :description, "支払いの内容" %>
    <%= f.text_field :description, class: "form-control" %>
  </div>

  <h3>いくら？</h3>
  <div class="form-group">
    <%= f.label :amount, "金額" %>
    <%= f.number_field :amount, class: "form-control" %>
  </div>

  <%= f.submit "支払った", class: "btn btn-primary btn-block" %>

<% end %>

<h2>精算履歴（最新3件）</h2>
<% if @expenses.any? %>
  <% @expenses.each do |expense| %>
    <ul>
      <li>
        <%= expense.payer.name %>が

        <% expense.shares.map(&:user).uniq.each do |user| %>
          <%= user.name %>に
        <% end %>

        <%= number_to_currency(expense.amount.round, unit: "¥", precision: 0) %>支払った

        <%= link_to edit_group_expense_path(@group.id,expense.id) do %>
          編集する
        <% end %>
      </li>
    </ul>
  <%= link_to "履歴を更に見る", group_expenses_path(@group.id) %>
  <% end %>
<% else %>
  精算履歴はありません
<% end %>

<h2>精算結果</h2>
<% if @settlements.present? %>
  <ul class="list-group">
    <% @settlements.each do |s| %>
      <li class="list-group-item">
        <%= s[:from].name %> が <%= s[:to].name %> に
        <%= number_to_currency(s[:amount].ceil, unit: "¥", precision: 0) %> 支払う
      </li>
    <% end %>
  </ul>
<% else %>
  <p>精算は必要ありません。</p>
<% end %>

<%= link_to "精算をリセット", destroy_all_group_expenses_path(@group.id), method: :delete, data: { confirm: '本当に削除しますか？' }, class: "btn btn-danger btn-block mb-2" %>